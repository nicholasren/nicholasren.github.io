---
layout: post
title: "Rx revisit"
comments: true
---
### TLDR;
æœ¬æ–‡æ˜¯[rx-java](http://nicholas.ren/2014/05/09/about-rx-java.html)çš„åç»­,
å°†ç®€è¦ä»‹ç»Rxä¸­çš„å¤šçº¿ç¨‹å®ç°æœºåˆ¶ï¼Œå¦å¤–ä¼šå¯¹å…¶å®ç°ä¸­çš„ä¸€ä¸ªé‡è¦å‡½æ•°`lift`å‡½æ•°åŸç†è¿›è¡Œä»‹ç»ã€‚

###Rx
Rxå®é™…ä¸Šæ˜¯ä¸€ç§é«˜çº§ç‰ˆæœ¬çš„`Observer`æ¨¡å¼ï¼ŒæŠŠè¢«è§‚å¯Ÿè€…å°è£…æˆ`Observable`ï¼ˆå¯ç†è§£ä¸ºä¸€ä¸ªå¼‚æ­¥åœ°ç”Ÿäº§å…ƒç´ çš„é›†åˆï¼‰ï¼Œ
ç„¶åé€šè¿‡ `onNext`, `onError`, `onCompleted`æ³¨å†Œ`Observer`åœ¨ç›¸åº”åœºæ™¯ä¸‹éœ€è¦æ‰§è¡Œçš„__å›è°ƒ__ã€‚
å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒRxä¸º`Observable`æä¾›äº†çš„`filter`,`map/flatMap`, `merge`, `reduce`ç­‰æ“ä½œï¼Œä½¿å¾—å¯¹è¢«è§‚å¯Ÿè€…çš„æ“ä½œå°±åƒåŒæ­¥é›†åˆé‚£ä¹ˆä¾¿åˆ©ã€‚

###Worker
å›è°ƒçš„å®é™…æ‰§è¡Œè€…ï¼Œåº•å±‚ç”±`java.util.concurrent.ExecutorService`æ‰§è¡Œå®é™…çš„ä»»åŠ¡ï¼ŒåŒæ—¶æ‰®æ¼”äº†`Subscription`çš„è§’è‰²ã€‚

###Scheduler
Rxçš„é»˜è®¤è¡Œä¸ºæ˜¯å•çº¿ç¨‹çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ª`free-threaded` <sup>t1</sup>æ¨¡å‹ï¼Œæ„å‘³ç€ä½ å¯ä»¥è‡ªç”±é€‰æ‹©ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä½ æŒ‡å®šçš„ä»»åŠ¡ã€‚
å¦‚æœä½ åˆ›å»ºObservableæ—¶æ²¡æœ‰å¼•å…¥`scheduler`,é‚£ä¹ˆä½ æ³¨å†Œçš„`onNext`, `onError`, `onCompleted`å›è°ƒå°†è¢«å½“å‰çº¿ç¨‹(å³ï¼Œåˆ›å»ºObservableä»£ç æ‰€åœ¨çº¿ç¨‹)ä¸Šæ‰§è¡Œã€‚
Scheduleræä¾›ä¸€ç§æœºåˆ¶ï¼Œç”¨äºæŒ‡å®šå°†ä¼šæ‰§è¡Œå›è°ƒçš„çº¿ç¨‹ã€‚

#### Schedulerçš„å¤šç§å®ç°ï¼š

- EventLoopsScheduler

  ç»´æŠ¤ä¸€ç»„workers,å½“æœ‰æ–°çš„ä»»åŠ¡åŠ å…¥`#schedule`æ—¶ï¼Œé€šè¿‡`round-robin`çš„æ–¹å¼é€‰å–ä¸€ä¸ªworkerï¼Œå°†ä»»åŠ¡åˆ†é…ç»™å…¶æ‰§è¡Œ`Worer#scheduleActual`

- CachedThreadScheduler

  ä½¿ç”¨ä¸€ä¸ª`ConcurrentLinkedQueue`ç¼“å­˜åˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹ä»¥å¤‡åç»­ä»»åŠ¡ä½¿ç”¨ï¼Œåˆ›å»ºå‡ºæ¥çš„çº¿ç¨‹æœ‰ä¸€å®šçš„æœ‰æ•ˆæœŸï¼Œè¶…è¿‡æœ‰æ•ˆæœŸçš„çº¿ç¨‹ä¼šè¢«è‡ªåŠ¨æ¸…é™¤ã€‚

- ExecutorScheduler

  åŒ…è£…äº†ä¸€ä¸ª`Executor`çš„å®ä¾‹å¹¶ï¼Œå¹¶åŸºäºå®ƒå®ç°äº†`Scheduler`çš„æ¥å£ã€‚
  æ³¨æ„ï¼Œåœ¨è¿™ä¸ªå®ç°é‡Œï¼Œ`thread-hopping(çº¿ç¨‹è·³è·ƒ)`é—®é¢˜æ˜¯ä¸å¯é¿å…çš„ï¼Œå› ä¸º`Scheduler`å¹¶ä¸çŸ¥æ™“å…¶åŒ…è£…çš„`Executor`çš„çº¿ç¨‹è¡Œä¸ºã€‚

- ImmediateScheduler

  ç«‹å³åœ¨å½“å‰çº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡ã€‚

- TrampolineScheduler

  æŠŠä»»åŠ¡åˆ†é…ç»™å½“å‰çº¿ç¨‹ï¼Œä½†å¹¶ä¸ç«‹å³æ‰§è¡Œï¼Œä»»åŠ¡ä¼šè¢«æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ç­‰å¾…å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚


#### liftå‡½æ•°
åœ¨Observableçš„å®ç°é‡Œï¼Œæœ‰ä¸ªå‡½æ•°å¿…é¡»å¾—æä¸€ä¸‹ï¼Œ`lift`ã€‚

Rxä¸­å·§å¦™æå‡ºä¸€ä¸ª`Operator`çš„è¿™ä¸ªå‡½æ•°ç±»å‹ï¼Œè¡¨è¿°ä»ä¸€ä¸ª`Subscriber` åˆ°å¦ä¸€ä¸ª `Subscriber`çš„æ˜ å°„ã€‚

æœ‰å¤§é‡å¯¹Observableçš„æ“ä½œæ˜¯é€šè¿‡å®šä¹‰`Operator` å¹¶ `lift` åˆ°`Observable`ä¸Šå®ç°çš„ï¼Œå¦‚`Observable#all`, `Observable#filter`, `Observable#finallyDo`ç­‰ç­‰ã€‚

`Observable#lift`ç­¾åå¦‚ä¸‹ï¼š

{% highlight scala%}
//inside Observable[T]
def lift[T, R](Operator[R, T]): Observable[R]
{% endhighlight%}

#####liftå‡½æ•°ç®€ä»‹
æœ‰ä¸€å®šå‡½æ•°å¼ç¼–ç¨‹åŸºç¡€çš„äººç›¸ä¿¡å¯¹`lift`è¿™ä¸ªåå­—éƒ½ä¸ä¼šå¤ªé™Œç”Ÿã€‚
`lift`é¡¾åæ€ä¹‰ï¼ŒæŠŠä¸€ä¸ªå¯¹ç®€å•ç±»å‹æ“ä½œçš„å‡½æ•°æå‡(`lift`)åˆ°å¤æ‚ç±»å‹/å®¹å™¨ç±»å‹ä¸Šå»ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªå¯¹liftçš„å®šä¹‰:
```
æœ‰ä¸ªä¸¤ä¸ªç±»å‹ A, B
å’Œä¸€ä¸ªå‡½æ•° f: A => B
å’Œä¸€ä¸ªå®¹å™¨ M[_]
lift å°±æ˜¯æŠŠfè½¬æ¢æˆä¸€ä¸ªæ–°çš„å‡½æ•° M[A] => M[B]
```

é‚£ä¹ˆliftçš„å®šä¹‰å¦‚ä¸‹:

{% highlight scala%}
 def lift[A, B, M[_]](f: A => B): M[A] => M[B]
{% endhighlight%}

è·Ÿä¸Šé¢çœ‹åˆ°çš„`Observable#lift`å”¯ä¸€ä¸åŒçš„åœ°æ–¹åœ¨äºï¼Œè¿™ä¸ª`lift`å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œ
ä¸è¿‡å†ä»”ç»†è§‚å¯Ÿä¸€ä¸‹ï¼Œè¿™ä¸ª`M[A] => M[B]`åº”ç”¨åˆ°ä¸€ä¸ª`M[A]`å®ä¾‹åçš„æ•ˆæœå’Œä¸Šé¢çš„`Observable#lift`æ˜¯ä¸€æ ·çš„ã€‚

å¬èµ·æ¥æ¯”è¾ƒæŠ½è±¡ï¼Œå…¶å®åªè¦æˆ‘ä»¬æŠŠä¸Šé¢çš„ç¬¦å·é€ä¸ªæ›¿æ¢æˆæˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„ç±»å‹ï¼Œè¿™ä¸ªå‡½æ•°ä¸€ç‚¹éƒ½ä¸é™Œç”Ÿã€‚
æˆ‘ä»¬æ¥é€æ­¥åº”ç”¨å¦‚ä¸‹æ›¿æ¢æ³•åˆ™:

- `A: String`
- `B: Int`
- `M: List[_]`
- `f: String => Int`

å› æ­¤ï¼Œ`lift`çš„ç±»å‹ç­¾åå¦‚ä¸‹ï¼š

`(String => Int) => (List[String => List[Int])`

æˆ‘ä»¬å°±æš‚ä¸”ç”¨ `(s: String) => s.length`åšä¸ºæˆ‘ä»¬çš„`f`å§ï¼Œ

å‡å¦‚æœ‰ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ `xs: List[String]`ï¼Œ

é‚£ä¹ˆ `lift(f)(xs)` å°±ä¼šå¾—åˆ°xsçš„ä¸­æ¯ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦ã€‚

ä»€ä¹ˆï¼Ÿ

è¿™ä¸å°±æ˜¯ `xs.map(f)`çš„ç»“æœå—ï¼Ÿ

æ˜¯çš„ï¼Œ`map`å‡½æ•°å°±æ˜¯ä¸€ç§å¸¸è§çš„`lift`å‡½æ•°ã€‚


##### Observable#lift
æˆ‘ä»¬å†æ¥çœ‹çœ‹`lift`åœ¨`Observable`ä¸­å‘æŒ¥äº†ä»€ä¹ˆæ ·çš„ä½œç”¨ï¼Ÿ

åœ¨å¼€å§‹ä¹‹å‰å¤§å®¶éœ€è¦è®°ä½è¿™å‡ ä¸ªç±»å‹ç­‰å¼(`:=` è¡¨ç¤ºå…¶å·¦å³ä¸¤è¾¹çš„ç±»å‹ç›¸ç­‰)ï¼š
- `Observable[_] := Subscriber[_] => Unit`
- `Operator[T, R] := Subscriber[R] => Subscriber[T]`


ç°åœ¨æˆ‘ä»¬æ¥åšç±»å‹æ›¿æ¢:
- `A: Subscriber[R]`
- `B: Subscriber[T]`
- `M: Observable[_]  (å³ Subscriber[_] => Unit)`
- `f: Subscriber[R] => Subscriber[T]`

å› æ­¤liftå°±æ˜¯

{% highlight scala%}
(Subscriber[R] => Subscriber[T]) => (Subscriber[T] => Unit) => (Subscriber[R] => Unit)
{% endhighlight%}
äº¦å³

{% highlight scala%}
(Subscriber[R] => Subscriber[T]) => (Observable[T] => Observable[R])
{% endhighlight%}

å‡å¦‚æœ‰ä¸ª`ts: Observable[T]` å’Œä¸€ä¸ªå‡½æ•°`f: Subscriber[R] => Subscriber[T]`,é€šè¿‡`lift`å‡½æ•°ï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°ä¸€ä¸ªç±»å‹ä¸º `Observable[R]`çš„ç»“æœã€‚

---
_t1:_ ä¸`free-threaded`æ¨¡å‹ç›¸å¯¹çš„æ˜¯`single-threaded apartment`,æ„å‘³ç€ä½ å¿…é¡»é€šè¿‡ä¸€ä¸ªæŒ‡å®šçš„çº¿ç¨‹ä¸ç³»ç»Ÿäº¤äº’ã€‚
